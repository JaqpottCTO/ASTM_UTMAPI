openapi: 3.0.0
info:
  description: >-
    Interface definitions for the Demand Capacity Balancing function within the Providers of Services to UAM (PSU)
    interoperability network. Functionality includes sharing demand capacity balancing information and receiving 
    operation intent details from other PSU OIM functions.
  version: 0.0.0
  title: ASTM UAM PSU DCB API
  contact: 
    name: Rafal Kicinger
    email: rafal.kicinger@metronaviation.com
    url: https://www.metronaviation.com

servers:
#TODO: change this list of servers
  - url: "/" 

security:
  - fimsAzAuth: []

tags:
  - name: Operational intent details
    description: |-
      Endpoints exposed by PSU DCBs to recieve details of operational intents based on a subscription.
  - name: Resource details
    description: "Endpoints exposed by PSU DCBs to receive details of resources based on a subscription"
  - name: DCB query
    description: "Endpoints exposed by PSU DCBs for interfacing with PSU OIMs"
 
paths:
  /dcb/v1/imbalance/intent:
    post:
      #Copied summary to description
      description: >-
        Demand-capacity imbalance detection endpoint that requires users to submit 
        a planned operational intent to detect whether the resources included in this 
        operational intent are below, at, or above available capacity. The returned 
        demand-capacity imbalance responses do NOT include contributions from the planned 
        operational intent but only consider operational intents known to DSS.
      tags:
        - DCB query
      summary: >-
        Demand-capacity imbalance detection endpoint that requires users to submit a planned operational intent to detect whether the resources included in this operational intent are below, at, or above available capacity. The returned demand-capacity imbalance responses do NOT include contributions from the planned operational intent but only consider operational intents known to DSS. 
      operationId: postImbalanceIntent
      parameters:
        - name: timeBuffer
          in: query
          required: false
          description: Parameter defining a time buffer in minutes around resource ETAs (ETA-timeBuffer, ETA+timeBuffer) for which demand capacity imbalances are requested
          schema:
            type: integer
            minimum: 0
            maximum: 120
            default: 0
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntentBasedImbalanceRequest'
      responses:
        '200':
          description: >-
            Demand-capacity imbalance status for the resources included in the planned operational intent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImbalanceResponse'
        '400':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            One or more parameters were missing or invalid.
        '401':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Bearer access token was not provided in Authorization header,
            token could not be decoded, or token was invalid.
        '415':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Request Content-type header was different from the required application/json.
        '429':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            The number of requests exceeded DCB processing capabilities. The client should wait and then retry sending the request.
        '500':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service error.
        '503':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service availability error triggered by unavailability of one or more required services such as DSS.
            
  /dcb/v1/imbalance/area:
    post:
      #Copied summary to description
      description: >-
        Demand-capacity imbalance detection endpoint that requires users to submit a 
        specification of area of interest defined as Volume4D to detect whether the 
        resources included in this areas are under, at, or over available capacity.
      tags:
        - DCB query
      summary: >-
        Demand-capacity imbalance detection endpoint that requires users to submit a specification of area of interest defined as Volume4D to detect whether the resources included in this areas are under, at, or over available capacity. 
      operationId: postImbalanceArea
      parameters:
        - name: timePeriod
          in: query
          required: true
          description: Parameter defining the time period for which demand capacity imbalances are requested. Default end-time is 24 hours from the start-time.
          schema:
            type: object
            $ref: '#/components/schemas/TimePeriod'
            # properties:
            #   time_start:
            #     type: string
            #     format: "iso8601"
            #     minLength: 20
            #     maxLength: 24
            #     pattern: "^([0-9]{4})-(1[0-2]|0[1-9])-(3[01]|0[1-9]|[12][0-9])T(2[0-3]|[01][0-9]):([0-5][0-9]):([0-5][0-9])(\\.[0-9]{1,3})?Z$"
            #     example: "2021-12-08T14:00:00Z"
            #   time_end:
            #     type: string
            #     format: "iso8601"
            #     minLength: 20
            #     maxLength: 24
            #     pattern: "^([0-9]{4})-(1[0-2]|0[1-9])-(3[01]|0[1-9]|[12][0-9])T(2[0-3]|[01][0-9]):([0-5][0-9]):([0-5][0-9])(\\.[0-9]{1,3})?Z$"
            #     example: "2021-12-08T16:00:00Z"

      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AreaBasedImbalanceRequest'
      responses:
        '200':
          description: >-
            Demand-capacity imbalance status for the resources included in the area of interest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImbalanceResponse'
        '400':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            One or more parameters were missing or invalid.
        '401':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Bearer access token was not provided in Authorization header,
            token could not be decoded, or token was invalid.
        '415':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Request Content-type header was different from the required application/json.
        '429':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            The number of requests exceeded DCB processing capabilities. The client should wait and then retry sending the request.
        '500':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service error.   
        '503':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service availability error triggered by unavailability of one or more required services such as DSS.
  
  /dcb/v1/imbalance/standalone:
    post:
      #Copied summary to description
      description: >-
        Demand-capacity imbalance detection endpoint that requires users to submit a 
        planned operational intent to detect whether the resources included in this 
        operational intent are below, at, or above available capacity. Contrary to the 
        /dcb/v2/imbalance/intent endpoint it does not check with the DSS regarding the 
        operational intents known to DSS but uses operational intents provided as background 
        demand to compute resource imbalances. This endpoint is mostly suitable for testing 
        since the client controls all the inputs required for demand-capacity calculations 
        (i.e., the calculations are not dependent on the dynamically changing status of DSS 
        operational intents and capacities are assumed to be static).
      tags:
        - DCB query
      summary: >-
        Demand-capacity imbalance detection endpoint that requires users to submit a planned operational intent to detect whether the resources included in this operational intent are below, at, or above available capacity. Contrary to the /dcb/v2/imbalance/intent endpoint it does not check with the DSS regarding the operational intents known to DSS but uses operational intents provided as background demand to compute resource imbalances. This endpoint is mostly suitable for testing since the client controls all the inputs required for demand-capacity calculations (i.e., the calculations are not dependent on the dynamically changing status of DSS operational intents and capacities are assumed to be static).
      operationId: postImbalanceStandalone
      parameters:
        - name: timeBuffer
          in: query
          required: false
          description: Parameter defining a time buffer in minutes around resource ETAs (ETA-timeBuffer, ETA+timeBuffer) for which demand capacity imbalances are requested
          schema:
            type: integer
            minimum: 0
            maximum: 120
            default: 0
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StandaloneImbalanceRequest'
      responses:
        '200':
          description: >-
            Demand-capacity imbalance status for the resources included in the planned operational intent
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ImbalanceResponse'
        '400':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            One or more parameters were missing or invalid.
        '401':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            Bearer access token was not provided in Authorization header,
            token could not be decoded, or token was invalid.
        '415':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            Request Content-type header was different from the required application/json.
        '429':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            The number of requests exceeded the processing capabilities. The client should wait and then retry sending the request.
        '500':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service error.
  
  
  /dcb/v1/availability/{resourceId}:
    get:
      description: >-
        Resource availability endpoint that provides information on available time intervals 
        for a given resource, i.e., time intervals during which demand is below available capacity.
      tags:
        - DCB query
      summary: >-
        Resource availability endpoint that provides information on available time intervals for a given resource, i.e., 
        time intervals during which demand is below available capacity. 
      operationId: getAvailabilityByResource
      parameters:
        - name: resourceId
          in: path
          description: Id of the resource
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityID'
        - name: time_start
          in: query
          required: true
          description: Parameter defining the start time for querying resource availability
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'
        - name: time_end
          in: query
          required: true
          description: Parameter defining the end time for querying resource availability
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'
        # TODO: Why do we need this? 
        # - name: exempt_Id
        #   in: query
        #   description: Entity id of operational intent that is exempt from demand estimation
        #   required: false
        #   schema:
        #     anyOf:
        #       - $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/UUIDv4'
        #     example: 2f8343be-6482-4d1b-a474-16847e01af1e
      responses:
        '200':
          description: >-
            Resource availability information
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/AvailabilityResponse'
        '400':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: >-
            One or more parameters were missing or invalid.
        '401':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Bearer access token was not provided in Authorization header,
            token could not be decoded, or token was invalid.   
        '404':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            Provided resname is not a valid vertiport name. 
        '429':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            The number of requests exceeded the processing capabilities. The client should wait and then retry sending the request.
        '500':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB server or processing error.
        '503':
          content:
            application/json:
              schema:
                $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/ErrorResponse'
          description: |-
            DCB service availability error triggered by unavailability of one or more required services such as DSS.
components:
  securitySchemes:
    fimsAzAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |- 
         This security scheme is applied to all operations, and the bearer token
         must be acquired from the FIMS-AZ. The scope must be 'utm.strategic_coordination' and the 
         'aud' claim must be 'dcb-uam.metronaviation.com'.
         
  schemas:
    IntentBasedImbalanceRequest:
      type: object
      required:
        - planned_operation
      properties:
        planned_operation:
          $ref: '#/components/schemas/OperationalIntent'
      description: >- 
            Operational intent that is being planned and for which resource demand capacity 
            imbalances need to be checked. The 'ovn' attribute in the operational intert reference 
            is not required/processed since it is assumed that this DCB endpoint is checked first 
            before communicating with DSS. 


    AreaBasedImbalanceRequest:
      type: object
      required:
        - areas_of_interest
      properties:
        areas_of_interest:
          type: array
          items:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Volume4D'
        exempt_resource_ids:
          description: Resources which may be located in/very near the area of interest, but do
            not need to be included in this query. 
          type: array
          items:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityID'
          
            
    StandaloneImbalanceRequest:
      type: object
      #Moved description out of properties
      description: |- 
        Operational intent that is being planned and for which resource demand capacity imbalances need to be checked. 
        The 'ovn' attribute in the operational intent reference is not required/processed since it is assumed that this 
        DCB endpoint is checked first before communicating with DSS. 
      required:
        - planned_operation
        - background_demand
      properties:
        planned_operation:
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/OperationalIntent'
        background_demand:
          type: array
          items:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/OperationalIntent'
          minItems: 0

    ImbalanceResponse:
      type: object
      required:
        - resource_imbalances
      properties:
        resource_imbalances:
          type: array
          items:
            $ref: '#/components/schemas/ResourceDemandCapacityImbalance'

    ResourceDemandCapacityImbalance:
      type: object
      description: >-
        a set of properties describing a resource imbalance status that includes a resource reference from the adaptation data, 
        the start and end time of the time bin used for demand-capacity imbalance computation, the magnitude of the imbalance, 
        the imbalance status, and a potentially empty set of OVNs for all operations contributing to the reported demand at this resource at this time bin
      required:
        - resource_id
        - resource_ovn
        - time_start
        # - time_end - only if we have a limit during a time duration. Otherwise empty. 
        - imbalance_magnitude
        - imbalance_status
        - operation_ovns
      properties:
        resource_id:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityID'
        resource_ovn:
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityOVN'
          description: >-
            OVN proving knowledge of the latest status & capacity info for the resource. 
        time_start:
          description: Beginning time of the time bin for computing this demand capacity imbalance status. If the capacity requirements
            are based on rate or an instantaneous limit, this value will be the time when that capacity rule began. Must be before time_end.
          anyOf:
            - $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'
        time_end:
          description: End time  of the time bin for computing this demand capacity imbalance status. Can be empty if the capacity rule
            in place is an instantaneous or rate limit.  If included, must be after time_start.
          anyOf:
            - $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'     
        imbalance_magnitude:
          type: number
          format: double
          description: The magnitude of demand capacity imbalance. Negative values indicate available capacity, zero indicates at capacity, 
            and positive values indicate over capacity
        imbalance_status:
          type: string
          enum:
            - OVER_CAPACITY
            - AT_CAPACITY
            - UNDER_CAPACITY
          description: >-
            string indicating whether corresponding resource is over, at or under capacity
        operation_ovns:
          type: array
          items:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityOVN'
          minItems: 0
          description: >-
            OVNs for all operations contributing to the reported demand at this resource at this time bin

          
    AvailabilityResponse:
      description: Returns a list of time intervals within the provided start/end duration during which
        the demand is under the capacity of the resource.  Returns all the OVNs for the demand operations. 
      type: object
      required:
        - resource_id
        - resource_ovn
        - available_intervals
      properties:
        resource_id:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityID'
        resource_ovn:
          $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityOVN'
          description: >-
            OVN proving knowledge of the latest status & capacity info for the resource. 
        available_intervals:
          type: array
          items:
            $ref: '#/components/schemas/ResourceAvailabilityInterval'
 
    ResourceAvailabilityInterval:
      description: An interval of time when the resource is UNDER_CAPACITY. Includes the OVNs
        for all operations contributing to the demand within that interval. 
      type: object
      required:
        - time_start
        - time_end
        - operation_ovns
      properties:
        time_start:
          description: Beginning time of this availability time interval. Must be before time_end.
          anyOf:
            - $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'
        time_end:
          description: End time of this availability time interval. Must be after time_start.
          anyOf:
            - $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/Time'        
        operation_ovns:
          type: array
          items:
            $ref: '#../DSS/astm-uam-psu-dss-0.0.0/components/schemas/EntityOVN'
          minItems: 0
          description: >-
            OVNs for all operations contributing to the reported demand at this resource during this time interval          
            
             

